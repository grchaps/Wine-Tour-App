import json
import os
import urllib2

#MAKE SURE YOU RUN `python manage.py reset wines` before running this

#Set environment variable to access database
os.environ['DJANGO_SETTINGS_MODULE'] = 'wine_tour.settings'

import wine_tour
from wines.models import Wine, WineProducer

WINERIES = {}
DATA_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)),
			'backend', 'raw_data')

def get_coordinates(address):
    """Given the `id` of a WineProducer, return the latitude and 
    longitude of the WineProducer as a tuple"""
    print 'Getting coordinates for address: %s' % address
    response = urllib2.urlopen('http://maps.googleapis.com/maps' + \
		'/api/geocode/json?address=%s&sensor=false' \
		% address.replace(' ', '+')) 
    try:
	obj = json.loads(response.read())['results'][0]['geometry']['location']
	return (float(obj['lat']), float(obj['lng']))
    except (KeyError, IndexError):
	return 

def main():
    """Loads data from JSON Django model fixture representations, 
    creates Django models, and links Wines to their WineProducers"""
    f = open(os.path.join(DATA_DIR, 'winery_catalogue_fixture.json'), 'r')
    wineries = json.load(f)
    f.close()
    
    for winery in wineries:
	fields = winery['fields']
	coordinates = get_coordinates(fields['address'])
	w = WineProducer(name=fields['name'],
			 address=fields['address'],
			 lat=coordinates[0] if coordinates else None,
			 lng=coordinates[1] if coordinates else None)
	WINERIES[fields['name']] = w
	w.save()

    f = open(os.path.join(DATA_DIR, 'wine_catalogue_fixture.json'), 'r')
    wines = json.load(f)
    f.close()

    for wine in wines:
	fields = wine['fields']
	w = Wine(name=fields['name'],
		 country=fields['country'],
		 style=fields['style'],
		 wine_producer=WINERIES[fields['wine_producer']])

	if 'appellation' in fields:
	    w.appellation = fields['appellation']
	if 'color' in fields:
	    w.color = fields['color']
	if 'fruit_source' in fields:
	    w.fruit_source = fields['fruit_source']
	if 'percent_new_oak' in fields:
	    w.percent_new_oak = fields['percent_new_oak']
	if 'percentage_alcohol' in fields:
	    w.percentage_alcohol = fields['percentage_alcohol']
	if 'region' in fields:
	    w.region = fields['region']
	if 'vineyard' in fields:
	    w.vineyard = fields['vineyard']
	if 'vintage' in fields:
	    w.vintage = fields['vintage']
	if 'vineyard' in fields:
	    w.vineyard = fields['vineyard']
	if 'wine_sub_region' in fields:
	    w.sub_region = fields['wine_sub_region']
	if 'wine_type' in fields:
	    w.wine_type = fields['wine_type']
	
	w.save()
if __name__ == '__main__':
    main()
